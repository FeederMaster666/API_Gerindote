<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reservar Espacio Deportivo</title>
  <link rel="stylesheet" href="stylesheets/index.css">
  <link rel="stylesheet" href="stylesheets/reservas.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .hora-label {
      font-weight: bold;
    }
    .horas-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
    }
    .horas-table th, .horas-table td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      text-align: center;
    }
    .celda-disponible {
      background-color: #e9fbe9;
    }
    .celda-reservada {
      background-color: #f8d7da;
      color: #6c757d;
    }
    .selected {
      background-color: #bde5ff !important;
    }
    .reservar-btn {
      margin-top: 1.5rem;
    }
  </style>
</head>
<body>
  <main>
    <div class="reserva-container container mt-5">
      <h2>Reservar Espacio Deportivo</h2>
      <form id="form-reserva">
        <div class="form-group">
          <label for="espacio">Espacio</label>
          <input type="text" id="espacio-nombre" class="form-control" readonly>
          <input type="hidden" id="espacio" name="espacio">
          <input type="hidden" id="fechas-semana">
        </div>
        <div id="horas-horarias-container"></div>
        <button type="submit" class="btn btn-primary w-100 reservar-btn">Reservar</button>
      </form>
      <div id="reserva-msg" class="mt-3"></div>
    </div>
  </main>

  <script>
    const nombresBonitos = {
      "Pabellon": "Pabellón Polideportivo",
      "Pistas de padel": "Pistas de Pádel",
      "Pistas de tenis": "Pistas de Tenis",
      "Salon Cultural": "Salón Cultural"
    };

    function getHoras() {
      const horas = [];
      // Mañana: 11:00 – 13:00 (11–12, 12–13)
      for (let h = 11; h < 13; h++) {
        horas.push({ inicio: h, fin: h + 1 });
      }
      // Tarde: 17:00 – 21:00 (17–18, 18–19, 19–20, 20–21)
      for (let h = 17; h < 21; h++) {
        horas.push({ inicio: h, fin: h + 1 });
      }
      return horas;
    }

    function obtenerSemanaActual() {
      const hoy = new Date();
      const diaActual = hoy.getDay();
      const lunes = new Date(hoy);
      lunes.setDate(hoy.getDate() - (diaActual === 0 ? 6 : diaActual - 1));
      const dias = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date(lunes);
        d.setDate(lunes.getDate() + i);
        dias.push(d.toISOString().split('T')[0]);
      }
      return dias;
    }

    async function cargarEspacio() {
      const params = new URLSearchParams(window.location.search);
      let espacio = params.get('espacio');
      if (!espacio) {
        const res = await fetch('/api/espacios');
        const espacios = await res.json();
        if (espacios.length > 0) espacio = espacios[0].nombre;
      }
      document.getElementById('espacio').value = espacio || '';
      document.getElementById('espacio-nombre').value = nombresBonitos[espacio] || espacio || '';
    }

    async function mostrarHorasSemana(fechas) {
      const container = document.getElementById('horas-horarias-container');
      const horas = getHoras();
      const espacio = document.getElementById('espacio').value;

      let reservas = [];
      try {
        const res = await fetch(`/api/reservas?espacio=${encodeURIComponent(espacio)}&fechas=${encodeURIComponent(JSON.stringify(fechas))}`);
        reservas = await res.json();
      } catch {}

      const reservadas = new Set(reservas.map(r => {
        const d = new Date(r.franjaHoraria);
        return d.toISOString().slice(0,16);
      }));

      let html = '<table class="horas-table"><thead><tr><th></th>';
      for (const fecha of fechas) {
        const d = new Date(fecha);
        const dias = ['Dom.', 'Lun.', 'Mar.', 'Mié.', 'Jue.', 'Vie.', 'Sáb.'];
        const meses = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
        const label = `${dias[d.getDay()]} ${d.getDate()} ${meses[d.getMonth()]}`;
        html += `<th>${label}</th>`;
      }
      html += '</tr></thead><tbody>';

      for (const bloque of horas) {
        const horaInicio = bloque.inicio.toString().padStart(2, '0') + ':00';
        const horaFin = bloque.fin.toString().padStart(2, '0') + ':00';
        html += `<tr><td class="hora-label">${horaInicio} – ${horaFin}</td>`;
        for (const fecha of fechas) {
          const keyISO = new Date(`${fecha}T${horaInicio}`).toISOString().slice(0,16);
          const reservado = reservadas.has(keyISO);
          html += `<td class="${reservado ? 'celda-reservada' : 'celda-disponible'}">`;
          if (reservado) {
            html += `<label>No disponible</label>`;
          } else {
            html += `<label>
              <input type="checkbox" class="hora-checkbox" value="${fecha}|${horaInicio}">
              Reservar
            </label>`;
          }
          html += '</td>';
        }
        html += '</tr>';
      }

      html += '</tbody></table>';
      container.innerHTML = html;

      document.querySelectorAll('.hora-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
          const td = cb.closest('td');
          td.classList.toggle('selected', cb.checked);
        });
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await cargarEspacio();

      const diasSemana = obtenerSemanaActual();
      document.getElementById('fechas-semana').value = diasSemana.join(',');
      mostrarHorasSemana(diasSemana);

      document.getElementById('form-reserva').onsubmit = async function(e) {
        e.preventDefault();
        const espacio = document.getElementById('espacio').value;
        const fechas = diasSemana;
        const msg = document.getElementById('reserva-msg');
        msg.textContent = '';

        const checks = document.querySelectorAll('.hora-checkbox:checked');
        if (!fechas.length || !checks.length || !espacio) {
          msg.textContent = 'Por favor, selecciona al menos una franja horaria.';
          msg.style.color = 'red';
          return;
        }

        const reservas = [];
        checks.forEach(cb => {
          const [fecha, hora] = cb.value.split('|');
          reservas.push({
            espacio,
            franjaHoraria: new Date(`${fecha}T${hora}:00`)
          });
        });

        let ok = 0, fail = 0;
        for (const reserva of reservas) {
          try {
            const res = await fetch('/api/reservas', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(reserva)
            });
            if (res.ok) ok++;
            else fail++;
          } catch {
            fail++;
          }
        }
        if (ok) {
          msg.textContent = `Reservas realizadas correctamente: ${ok}. Fallidas: ${fail ? fail : 0}`;
          msg.style.color = 'green';
        } else {
          msg.textContent = 'No se pudo realizar ninguna reserva.';
          msg.style.color = 'red';
        }
        mostrarHorasSemana(fechas);
      };
    });
  </script>
</body>
</html>
